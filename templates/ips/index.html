{% extends 'base.html' %}

{% block title %}Dashboard - IP Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div class="mb-3 mb-md-0">
                    <h1 class="page-title">
                        <i class="fas fa-network-wired me-2"></i>IP Management Dashboard
                    </h1>
                    <p class="text-muted">
                        Manage and monitor your network IP addresses
                        {% if not is_admin and user_branch %}
                        <span class="badge bg-info ms-2">
                            <i class="fas fa-building me-1"></i>{{ user_branch.name }}
                        </span>
                        {% endif %}
                        {% if is_admin %}
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-user-shield me-1"></i>Administrator
                        </span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Branch Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-building me-2"></i>Select Branch
                    </h5>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="branchSelect" class="form-label">Branch</label>
                            <select id="branchSelect" class="form-select">
                                <option value="">-- Select a Branch --</option>
                                {% if branches %}
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}">
                                        {{ branch.name }} ({{ branch.ip_count|default:0 }} IPs)
                                    </option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No branches available</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="networkSelect" class="form-label">Network (Optional)</label>
                            <select id="networkSelect" class="form-select" disabled>
                                <option value="">-- All Networks --</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar (Admin Only) -->
    {% if is_admin %}
    <div class="row mb-3" id="bulkActionsBar" style="display: none;">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-check-circle text-primary me-2"></i>
                            <strong id="selectedCount">0</strong> IP(s) selected
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-danger" id="bulkDeleteBtn">
                                <i class="fas fa-trash me-1"></i>Delete Selected
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSelectionBtn">
                                <i class="fas fa-times me-1"></i>Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- IP Addresses Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-list me-2"></i>IP Addresses
                    </h5>
                    <div class="table-responsive">
                        <table id="ipTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    {% if is_admin %}
                                    <th style="width: 50px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    {% endif %}
                                    <th>IP Address</th>
                                    <th>Device Name</th>
                                    <th>Device Type</th>
                                    <th>Subnet Mask</th>
                                    <th class="d-none d-lg-table-cell">Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="{% if is_admin %}7{% else %}6{% endif %}" class="text-center text-muted py-5">
                                        <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                                        Please select a branch to view IP addresses
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit IP Modal -->
<div class="modal fade" id="editIPModal" tabindex="-1" aria-labelledby="editIPModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editIPModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit IP Address
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="ipForm">
                    {% csrf_token %}
                    <input type="hidden" id="ipId" name="ip_id">
                    
                    <div class="mb-3">
                        <label for="ipAddress" class="form-label">IP Address *</label>
                        <input type="text" class="form-control" id="ipAddress" name="ip_address" 
                               placeholder="192.168.1.1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name *</label>
                        <input type="text" class="form-control" id="deviceName" name="device_name" 
                               placeholder="Server-01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="deviceType" class="form-label">Device Type *</label>
                        <select class="form-select" id="deviceType" name="device_type" required>
                            <option value="">-- Select Device Type --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subnet" class="form-label">Subnet Mask *</label>
                        <select class="form-select" id="subnet" name="subnet" required>
                            <option value="">-- Select Subnet --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="branch" class="form-label">Branch *</label>
                        <select class="form-select" id="branch" name="branch" required>
                            <option value="">-- Select Branch --</option>
                            {% if branches %}
                                {% for branch in branches %}
                                <option value="{{ branch.id }}">{{ branch.name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" placeholder="Optional description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveIPBtn">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ping Result Modal -->
<div class="modal fade" id="pingModal" tabindex="-1" aria-labelledby="pingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" id="pingModalHeader">
                <h5 class="modal-title" id="pingModalLabel">
                    <i class="fas fa-satellite-dish me-2"></i>Ping Result
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3" id="pingStatus">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Pinging...</span>
                    </div>
                    <p class="mt-2">Pinging <strong id="pingIPAddress"></strong>...</p>
                </div>
                <div id="pingOutput" style="display: none;">
                    <div class="alert" id="pingAlert">
                        <h6 id="pingResultTitle"></h6>
                        <p class="mb-0"><strong>Device:</strong> <span id="pingDeviceName"></span></p>
                    </div>
                    <pre id="pingOutputText" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; max-height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
{% if is_admin %}
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="bulkDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Bulk Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Are you sure you want to delete <strong id="deleteCount">0</strong> IP address(es)?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let ipTable;
let currentIPId = null;
const isAdmin = {{ is_admin|yesno:"true,false" }};
let selectedIPs = new Set();

$(document).ready(function() {
    // Check if branches exist
    if ($('#branchSelect option').length <= 1) {
        showAlert('warning', 'No branches found. Please contact administrator.');
    }
    
    // Load device types and subnets
    loadDeviceTypes();
    loadSubnets();
    
    // Branch selection change
    $('#branchSelect').on('change', function() {
        const branchId = $(this).val();
        selectedIPs.clear();
        updateBulkActionsBar();
        
        if (branchId) {
            loadNetworks(branchId);
            loadIPTable(branchId);
        } else {
            $('#networkSelect').prop('disabled', true).html('<option value="">-- All Networks --</option>');
            if (ipTable) {
                ipTable.destroy();
            }
            const colspan = isAdmin ? 7 : 6;
            $('#ipTable tbody').html('<tr><td colspan="' + colspan + '" class="text-center text-muted py-5"><i class="fas fa-info-circle fa-2x mb-3 d-block"></i>Please select a branch to view IP addresses</td></tr>');
        }
    });
    
    // Network filter change
    $('#networkSelect').on('change', function() {
        if (ipTable) {
            ipTable.ajax.reload();
        }
    });
    
    // Save IP button
    $('#saveIPBtn').on('click', function() {
        saveIP();
    });
    
    // Edit button handler
    $(document).on('click', '.edit-btn', function() {
        const ipId = $(this).data('id');
        loadIPForEdit(ipId);
    });
    
    // Ping button handler
    $(document).on('click', '.ping-btn', function() {
        const ipId = $(this).data('id');
        const ipAddress = $(this).data('ip');
        pingIP(ipId, ipAddress);
    });
    
    // Admin-only: Bulk actions
    if (isAdmin) {
        // Select all checkbox
        $('#selectAll').on('change', function() {
            const checked = $(this).prop('checked');
            $('.ip-checkbox:visible').prop('checked', checked);
            
            if (checked) {
                $('.ip-checkbox:visible').each(function() {
                    selectedIPs.add(parseInt($(this).val()));
                });
            } else {
                selectedIPs.clear();
            }
            updateBulkActionsBar();
        });
        
        // Individual checkbox
        $(document).on('change', '.ip-checkbox', function() {
            const ipId = parseInt($(this).val());
            if ($(this).prop('checked')) {
                selectedIPs.add(ipId);
            } else {
                selectedIPs.delete(ipId);
            }
            
            // Update "select all" checkbox
            const totalVisible = $('.ip-checkbox:visible').length;
            const totalChecked = $('.ip-checkbox:checked').length;
            $('#selectAll').prop('checked', totalVisible > 0 && totalVisible === totalChecked);
            
            updateBulkActionsBar();
        });
        
        // Bulk delete button
        $('#bulkDeleteBtn').on('click', function() {
            if (selectedIPs.size === 0) {
                showAlert('warning', 'Please select at least one IP address to delete');
                return;
            }
            $('#deleteCount').text(selectedIPs.size);
            $('#bulkDeleteModal').modal('show');
        });
        
        // Confirm bulk delete
        $('#confirmBulkDeleteBtn').on('click', function() {
            performBulkDelete();
        });
        
        // Clear selection button
        $('#clearSelectionBtn').on('click', function() {
            selectedIPs.clear();
            $('.ip-checkbox').prop('checked', false);
            $('#selectAll').prop('checked', false);
            updateBulkActionsBar();
        });
    }
    
    // Modal event handlers
    $('#editIPModal').on('shown.bs.modal', function() {
        initializeSelect2();
    });

    $('#editIPModal').on('hidden.bs.modal', function() {
        resetForm();
    });
});

// Update bulk actions bar visibility and count
function updateBulkActionsBar() {
    if (!isAdmin) return;
    
    const count = selectedIPs.size;
    $('#selectedCount').text(count);
    
    if (count > 0) {
        $('#bulkActionsBar').slideDown();
    } else {
        $('#bulkActionsBar').slideUp();
    }
}

// Perform bulk delete
function performBulkDelete() {
    const ipIds = Array.from(selectedIPs);
    
    $('#confirmBulkDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Deleting...');
    
    $.ajax({
        url: '/api/ips/bulk-delete/',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ip_ids: ipIds }),
        success: function(response) {
            $('#bulkDeleteModal').modal('hide');
            showAlert('success', response.message || `Successfully deleted ${response.deleted_count} IP address(es)`);
            
            // Clear selection and reload table
            selectedIPs.clear();
            updateBulkActionsBar();
            $('#selectAll').prop('checked', false);
            
            if (ipTable) {
                ipTable.ajax.reload();
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showAlert('danger', response.error || 'Error deleting IP addresses');
        },
        complete: function() {
            $('#confirmBulkDeleteBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>Delete');
        }
    });
}

// Initialize Select2 for modal selects
function initializeSelect2() {
    $('#editIPModal .form-select').each(function() {
        if ($(this).hasClass("select2-hidden-accessible")) {
            $(this).select2('destroy');
        }
        
        $(this).select2({
            theme: 'bootstrap-5',
            width: '100%',
            dropdownParent: $('#editIPModal')
        });
    });
}

function loadDeviceTypes() {
    $.get('/api/device-types/')
        .done(function(data) {
            const select = $('#deviceType');
            select.html('<option value="">-- Select Device Type --</option>');
            if (data && data.length > 0) {
                data.forEach(function(type) {
                    select.append('<option value="' + type.id + '">' + type.name + '</option>');
                });
            } else {
                select.append('<option value="" disabled>No device types available</option>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Error loading device types:', error);
            showAlert('danger', 'Error loading device types');
        });
}

function loadSubnets() {
    $.get('/api/subnets/')
        .done(function(data) {
            const select = $('#subnet');
            select.html('<option value="">-- Select Subnet --</option>');
            if (data && data.length > 0) {
                data.forEach(function(subnet) {
                    select.append('<option value="' + subnet.id + '">/' + subnet.prefix + ' (' + subnet.subnet_mask + ')</option>');
                });
            } else {
                select.append('<option value="" disabled>No subnets available</option>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Error loading subnets:', error);
            showAlert('danger', 'Error loading subnets');
        });
}

function loadNetworks(branchId) {
    $.get('/api/networks/', {branch_id: branchId})
        .done(function(data) {
            const select = $('#networkSelect');
            select.html('<option value="">-- All Networks --</option>');
            
            if (data && data.length > 0) {
                data.forEach(function(network) {
                    select.append('<option value="' + network.network + '" data-subnet="' + network.subnet_id + '">' + network.network + '/' + network.prefix + ' (' + network.ip_count + ' IPs)</option>');
                });
            } else {
                select.append('<option value="" disabled>No networks found</option>');
            }
            
            select.prop('disabled', false);
        })
        .fail(function(xhr, status, error) {
            console.error('Error loading networks:', error);
            showAlert('danger', 'Error loading networks. Please try again.');
        });
}

function loadIPTable(branchId, network, subnetId) {
    if (ipTable) {
        ipTable.destroy();
    }
    
    const columns = [];
    
    // Add checkbox column for admin
    if (isAdmin) {
        columns.push({
            data: null,
            orderable: false,
            className: 'text-center',
            render: function(data, type, row) {
                return '<input type="checkbox" class="form-check-input ip-checkbox" value="' + row.id + '">';
            }
        });
    }
    
    // Add other columns
    columns.push(
        { data: 'ip_address' },
        { data: 'device_name' },
        { data: 'device_type' },
        { data: 'subnet_mask' },
        { 
            data: 'description',
            className: 'd-none d-lg-table-cell',
            render: function(data, type, row) {
                return data || '<em class="text-muted">No description</em>';
            }
        },
        {
            data: null,
            orderable: false,
            render: function(data, type, row) {
                let mobileButtons = '<div class="d-md-none d-flex flex-column gap-1">';
                mobileButtons += '<button class="btn btn-sm btn-info ping-btn" data-id="' + row.id + '" data-ip="' + row.ip_address + '"><i class="fas fa-satellite-dish me-1"></i>Ping</button>';
                
                if (row.can_edit) {
                    mobileButtons += '<button class="btn btn-sm btn-primary edit-btn" data-id="' + row.id + '"><i class="fas fa-edit me-1"></i>Edit</button>';
                }
                mobileButtons += '</div>';
                
                let desktopButtons = '<div class="d-none d-md-inline-block">';
                desktopButtons += '<button class="btn btn-sm btn-info ping-btn me-1" data-id="' + row.id + '" data-ip="' + row.ip_address + '" title="Ping"><i class="fas fa-satellite-dish"></i></button>';
                
                if (row.can_edit) {
                    desktopButtons += '<button class="btn btn-sm btn-primary edit-btn" data-id="' + row.id + '" title="Edit"><i class="fas fa-edit"></i></button>';
                }
                desktopButtons += '</div>';
                
                return mobileButtons + desktopButtons;
            }
        }
    );
    
    ipTable = $('#ipTable').DataTable({
        processing: true,
        serverSide: true,
        responsive: true,
        ajax: {
            url: '/api/ips/datatable/',
            type: 'POST',
            data: function(d) {
                d.branch_id = branchId;
                d.network = $('#networkSelect').val() || '';
                d.subnet_id = $('#networkSelect option:selected').data('subnet') || '';
            },
            error: function(xhr, error, thrown) {
                console.error('DataTable error:', error);
                showAlert('danger', 'Error loading IP addresses');
            }
        },
        columns: columns,
        order: [[isAdmin ? 1 : 0, 'asc']], // Adjust order column index based on checkbox presence
        pageLength: 10,
        language: {
            emptyTable: "No IP addresses found for this branch",
            zeroRecords: "No matching IP addresses found",
            processing: "Loading IP addresses..."
        },
        drawCallback: function() {
            $('[title]').tooltip();
            
            // Restore checkboxes state
            if (isAdmin) {
                $('.ip-checkbox').each(function() {
                    const ipId = parseInt($(this).val());
                    if (selectedIPs.has(ipId)) {
                        $(this).prop('checked', true);
                    }
                });
                
                // Update "select all" checkbox
                const totalVisible = $('.ip-checkbox:visible').length;
                const totalChecked = $('.ip-checkbox:checked').length;
                $('#selectAll').prop('checked', totalVisible > 0 && totalVisible === totalChecked);
            }
        }
    });
}

function saveIP() {
    const ipId = $('#ipId').val();
    const url = '/ip/' + ipId + '/edit/';
    const formData = {
        ip_address: $('#ipAddress').val(),
        device_name: $('#deviceName').val(),
        device_type: $('#deviceType').val(),
        subnet: $('#subnet').val(),
        branch: $('#branch').val(),
        description: $('#description').val()
    };
    
    if (!formData.ip_address || !formData.device_name || !formData.device_type || 
        !formData.subnet || !formData.branch) {
        showAlert('warning', 'Please fill in all required fields');
        return;
    }
    
    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            $('#editIPModal').modal('hide');
            showAlert('success', response.message || 'IP address updated successfully');
            
            if ($('#branchSelect').val() && ipTable) {
                ipTable.ajax.reload();
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            if (response && response.errors) {
                let errorMsg = 'Please fix the following errors: ';
                for (let field in response.errors) {
                    errorMsg += response.errors[field].join(', ') + ' ';
                }
                showAlert('danger', errorMsg);
            } else {
                showAlert('danger', response.error || 'Error saving IP address');
            }
        }
    });
}

function loadIPForEdit(ipId) {
    $.ajax({
        url: '/ip/' + ipId + '/edit/',
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            const ip = response.ip;
            
            $('#ipId').val(ip.id);
            $('#ipAddress').val(ip.ip_address);
            $('#deviceName').val(ip.device_name);
            $('#description').val(ip.description);
            
            $('#deviceType').val(ip.device_type_id);
            $('#subnet').val(ip.subnet_id);
            $('#branch').val(ip.branch_id);
            
            $('#editIPModal').modal('show');
            
            setTimeout(function() {
                $('#deviceType').trigger('change');
                $('#subnet').trigger('change');
                $('#branch').trigger('change');
            }, 100);
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showAlert('danger', response.error || 'Error loading IP address');
        }
    });
}

function pingIP(ipId, ipAddress) {
    $('#pingModal').modal('show');
    $('#pingIPAddress').text(ipAddress);
    $('#pingStatus').show();
    $('#pingOutput').hide();
    
    $('#pingModalHeader').removeClass('bg-success bg-danger bg-warning').addClass('bg-primary text-white');
    
    $.ajax({
        url: '/ip/' + ipId + '/ping/',
        type: 'GET',
        success: function(response) {
            $('#pingStatus').hide();
            $('#pingOutput').show();
            
            $('#pingDeviceName').text(response.device_name);
            $('#pingOutputText').text(response.output);
            
            if (response.success) {
                $('#pingModalHeader').removeClass('bg-primary bg-danger bg-warning').addClass('bg-success text-white');
                $('#pingAlert').removeClass().addClass('alert alert-success');
                $('#pingResultTitle').html('<i class="fas fa-check-circle me-2"></i>Ping Successful - Host is Online');
            } else if (response.status === 'timeout') {
                $('#pingModalHeader').removeClass('bg-primary bg-success bg-danger').addClass('bg-warning text-white');
                $('#pingAlert').removeClass().addClass('alert alert-warning');
                $('#pingResultTitle').html('<i class="fas fa-clock me-2"></i>Ping Timeout');
            } else {
                $('#pingModalHeader').removeClass('bg-primary bg-success bg-warning').addClass('bg-danger text-white');
                $('#pingAlert').removeClass().addClass('alert alert-danger');
                $('#pingResultTitle').html('<i class="fas fa-times-circle me-2"></i>Ping Failed - Host is Offline');
            }
        },
        error: function(xhr) {
            $('#pingStatus').hide();
            $('#pingOutput').show();
            
            const response = xhr.responseJSON;
            $('#pingModalHeader').removeClass('bg-primary bg-success bg-warning').addClass('bg-danger text-white');
            $('#pingAlert').removeClass().addClass('alert alert-danger');
            $('#pingResultTitle').html('<i class="fas fa-exclamation-triangle me-2"></i>Error');
            $('#pingDeviceName').text('-');
            $('#pingOutputText').text(response.output || 'An error occurred while pinging the IP address');
        }
    });
}

function resetForm() {
    $('#ipForm')[0].reset();
    $('#ipId').val('');
    
    $('#editIPModal .form-select').each(function() {
        if ($(this).hasClass("select2-hidden-accessible")) {
            $(this).select2('destroy');
        }
    });
}
</script>
{% endblock %}