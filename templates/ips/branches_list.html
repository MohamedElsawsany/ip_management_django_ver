{% extends 'base.html' %}

{% block title %}Branch Management - IP Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div class="mb-3 mb-md-0">
                    <h1 class="page-title">
                        <i class="fas fa-building me-2"></i>Branch Management
                    </h1>
                    <p class="text-muted">Manage network branches and locations</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" id="addBranchBtn">
                        <i class="fas fa-plus me-2"></i>Add New Branch
                    </button>
                    <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Branches Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-list me-2"></i>All Branches
                    </h5>
                    <div class="table-responsive">
                        <table id="branchesTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Branch Name</th>
                                    <th>Total IPs</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for branch in branches %}
                                <tr data-branch-id="{{ branch.id }}">
                                    <td><strong>{{ branch.name }}</strong></td>
                                    <td>
                                        <span class="badge bg-info">{{ branch.ip_count }} IP(s)</span>
                                    </td>
                                    <td>{{ branch.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-primary edit-branch-btn" 
                                                    data-id="{{ branch.id }}" 
                                                    title="Edit Branch">
                                                <i class="fas fa-edit"></i>
                                                <span class="d-md-none ms-1">Edit</span>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-branch-btn" 
                                                    data-id="{{ branch.id }}" 
                                                    data-name="{{ branch.name }}" 
                                                    data-ip-count="{{ branch.ip_count }}"
                                                    title="Delete Branch">
                                                <i class="fas fa-trash"></i>
                                                <span class="d-md-none ms-1">Delete</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-5">
                                        <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                                        No branches found. Click "Add New Branch" to create one.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Branch Modal -->
<div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="branchModalLabel">
                    <i class="fas fa-building me-2"></i><span id="modalTitle">Add Branch</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="branchForm">
                    {% csrf_token %}
                    <input type="hidden" id="branchId" name="branch_id">
                    
                    <div class="mb-3">
                        <label for="branchName" class="form-label">Branch Name *</label>
                        <input type="text" class="form-control" id="branchName" name="name" 
                               placeholder="Enter branch name" required>
                        <div class="invalid-feedback" id="nameError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveBranchBtn">
                    <i class="fas fa-save me-2"></i>Save Branch
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the branch <strong id="deleteBranchName"></strong>?</p>
                <div class="alert alert-warning" id="deleteWarning" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="deleteWarningText"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete Branch
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentBranchId = null;
let branchesTable;

$(document).ready(function() {
    // Initialize DataTable
    branchesTable = $('#branchesTable').DataTable({
        order: [[0, 'asc']],
        pageLength: 25,
        responsive: true,
        columnDefs: [
            { orderable: false, targets: 3 }
        ],
        language: {
            emptyTable: "No branches found. Click 'Add New Branch' to create one.",
            zeroRecords: "No matching branches found",
            search: "Search branches:",
            lengthMenu: "Show _MENU_ branches per page",
            info: "Showing _START_ to _END_ of _TOTAL_ branches",
            infoEmpty: "No branches available",
            infoFiltered: "(filtered from _MAX_ total branches)"
        }
    });
    
    // Add branch button
    $('#addBranchBtn').on('click', function() {
        resetForm();
        $('#modalTitle').text('Add Branch');
        $('#branchModal').modal('show');
    });
    
    // Edit branch button
    $(document).on('click', '.edit-branch-btn', function() {
        const branchId = $(this).data('id');
        loadBranchForEdit(branchId);
    });
    
    // Delete branch button
    $(document).on('click', '.delete-branch-btn', function() {
        const branchId = $(this).data('id');
        const branchName = $(this).data('name');
        const ipCount = $(this).data('ip-count');
        
        currentBranchId = branchId;
        $('#deleteBranchName').text(branchName);
        
        if (ipCount > 0) {
            $('#deleteWarning').show();
            $('#deleteWarningText').text(`This branch has ${ipCount} IP address(es). You must delete or reassign them first.`);
            $('#confirmDeleteBtn').prop('disabled', true);
        } else {
            $('#deleteWarning').hide();
            $('#confirmDeleteBtn').prop('disabled', false);
        }
        
        $('#deleteModal').modal('show');
    });
    
    // Confirm delete
    $('#confirmDeleteBtn').on('click', function() {
        deleteBranch(currentBranchId);
    });
    
    // Save branch button
    $('#saveBranchBtn').on('click', function() {
        saveBranch();
    });
    
    // Reset form when modal is closed
    $('#branchModal').on('hidden.bs.modal', function() {
        resetForm();
    });
});

function saveBranch() {
    const branchId = $('#branchId').val();
    const branchName = $('#branchName').val().trim();
    
    if (!branchName) {
        $('#branchName').addClass('is-invalid');
        $('#nameError').text('Branch name is required');
        return;
    }
    
    const url = branchId ? `/branches/${branchId}/edit/` : '/branches/create/';
    const formData = {
        name: branchName
    };
    
    showLoading();
    
    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            hideLoading();
            $('#branchModal').modal('hide');
            showAlert('success', response.message);
            
            // Reload the page to refresh the table
            setTimeout(function() {
                location.reload();
            }, 1000);
        },
        error: function(xhr) {
            hideLoading();
            const response = xhr.responseJSON;
            
            if (response && response.errors && response.errors.name) {
                $('#branchName').addClass('is-invalid');
                $('#nameError').text(response.errors.name.join(', '));
            } else {
                showAlert('danger', response.error || 'Error saving branch');
            }
        }
    });
}

function loadBranchForEdit(branchId) {
    showLoading();
    
    $.ajax({
        url: `/branches/${branchId}/edit/`,
        type: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            hideLoading();
            const branch = response.branch;
            
            $('#branchId').val(branch.id);
            $('#branchName').val(branch.name);
            $('#modalTitle').text('Edit Branch');
            
            $('#branchModal').modal('show');
        },
        error: function(xhr) {
            hideLoading();
            const response = xhr.responseJSON;
            showAlert('danger', response.error || 'Error loading branch');
        }
    });
}

function deleteBranch(branchId) {
    showLoading();
    
    $.ajax({
        url: `/branches/${branchId}/delete/`,
        type: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            hideLoading();
            $('#deleteModal').modal('hide');
            showAlert('success', response.message);
            
            // Reload the page to refresh the table
            setTimeout(function() {
                location.reload();
            }, 1000);
        },
        error: function(xhr) {
            hideLoading();
            $('#deleteModal').modal('hide');
            const response = xhr.responseJSON;
            showAlert('danger', response.error || 'Error deleting branch');
        }
    });
}

function resetForm() {
    $('#branchForm')[0].reset();
    $('#branchId').val('');
    $('#branchName').removeClass('is-invalid');
    $('#nameError').text('');
}
</script>
{% endblock %}