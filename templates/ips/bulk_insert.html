{% extends 'base.html' %}

{% block title %}Bulk Insert - IP Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-upload me-2"></i>Bulk IP Insert
                </h1>
                <p class="text-muted">Insert multiple IP addresses in a range</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form id="bulkInsertForm">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startIP" class="form-label">Start IP Address *</label>
                                <input type="text" class="form-control" id="startIP" name="start_ip" 
                                       placeholder="172.16.0.0" required>
                                <small class="text-muted">Network starting address</small>
                            </div>
                            <div class="col-md-6">
                                <label for="subnetBulk" class="form-label">Subnet Mask *</label>
                                <select class="form-select" id="subnetBulk" name="subnet_id" required>
                                    <option value="">-- Select Subnet --</option>
                                    {% for subnet in subnets %}
                                    <option value="{{ subnet.id }}" 
                                            data-prefix="{{ subnet.prefix }}" 
                                            data-mask="{{ subnet.subnet_mask }}"
                                            data-usable="{{ subnet.usable_hosts }}">
                                        /{{ subnet.prefix }} ({{ subnet.subnet_mask }}) - {{ subnet.usable_hosts|floatformat:0 }} usable hosts
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Select subnet to auto-calculate range</small>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="endIP" class="form-label">
                                    End IP Address *
                                    <span class="badge bg-info" id="autoCalcBadge" style="display: none;">
                                        <i class="fas fa-magic"></i> Auto-calculated
                                    </span>
                                </label>
                                <input type="text" class="form-control" id="endIP" name="end_ip" 
                                       placeholder="172.31.255.255" required>
                                <small class="text-muted">Automatically calculated or enter manually</small>
                            </div>
                            <div class="col-md-6">
                                <label for="branchBulk" class="form-label">Branch *</label>
                                <select class="form-select" id="branchBulk" name="branch_id" required>
                                    <option value="">-- Select Branch --</option>
                                    {% for branch in branches %}
                                    <option value="{{ branch.id }}">{{ branch.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="deviceTypeBulk" class="form-label">Device Type *</label>
                                <select class="form-select" id="deviceTypeBulk" name="device_type_id" required>
                                    <option value="">-- Select Device Type --</option>
                                    {% for device_type in device_types %}
                                    <option value="{{ device_type.id }}">{{ device_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="devicePrefix" class="form-label">Device Name Prefix *</label>
                                <input type="text" class="form-control" id="devicePrefix" 
                                       name="device_name_prefix" value="Device" required>
                                <small class="text-muted">e.g., "Device" → "Device-172-16-0-1"</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descriptionBulk" class="form-label">Description</label>
                            <textarea class="form-control" id="descriptionBulk" name="description" 
                                      rows="2" placeholder="Optional description for all IPs">Bulk inserted IP range</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="skipExisting" 
                                       name="skip_existing" checked>
                                <label class="form-check-label" for="skipExisting">
                                    <strong>Skip existing IP addresses</strong>
                                    <small class="d-block text-muted">Recommended to avoid duplicate errors</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="bulkInsertBtn">
                                <i class="fas fa-upload me-2"></i>Start Bulk Insert
                            </button>
                            <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle me-2"></i>Instructions
                    </h5>
                    <ul class="mb-0">
                        <li>Enter the start IP address</li>
                        <li>Select subnet mask - end IP will be auto-calculated</li>
                        <li>Or manually enter both start and end IPs</li>
                        <li>Select branch and device type</li>
                        <li>Maximum 5,000,000 IPs per operation</li>
                        <li>Large ranges may take time to process</li>
                    </ul>
                </div>
            </div>
            
            <div class="card mb-3" id="subnetInfoCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-network-wired me-2"></i>Subnet Information
                    </h5>
                    <div id="subnetDetails" class="alert alert-info mb-0">
                        <p class="mb-1"><strong>Subnet:</strong> <span id="subnetDisplay">-</span></p>
                        <p class="mb-1"><strong>Mask:</strong> <span id="maskDisplay">-</span></p>
                        <p class="mb-1"><strong>Total Addresses:</strong> <span id="totalAddresses">-</span></p>
                        <p class="mb-0"><strong>Usable Hosts:</strong> <span id="usableHosts">-</span></p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-calculator me-2"></i>IP Range Calculator
                    </h5>
                    <div id="rangeInfo" class="alert alert-info mb-0">
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Enter start IP and select subnet to calculate range
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Progress Card -->
            <div class="card mt-3" id="progressCard" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-tasks me-2"></i>Progress
                    </h5>
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="progressBar" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <div id="progressText" class="text-center">
                        <small class="text-muted">Preparing...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" 
         aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="resultsModalLabel">
                        <i class="fas fa-check-circle me-2"></i>Bulk Insert Complete
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon bg-success bg-opacity-10 text-success mx-auto mb-2">
                                    <i class="fas fa-check"></i>
                                </div>
                                <h3 class="mb-0" id="insertedCount">0</h3>
                                <small class="text-muted">Inserted</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning bg-opacity-10 text-warning mx-auto mb-2">
                                    <i class="fas fa-forward"></i>
                                </div>
                                <h3 class="mb-0" id="skippedCount">0</h3>
                                <small class="text-muted">Skipped</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-icon bg-info bg-opacity-10 text-info mx-auto mb-2">
                                    <i class="fas fa-list"></i>
                                </div>
                                <h3 class="mb-0" id="totalCount">0</h3>
                                <small class="text-muted">Total Processed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="resultDetails"></div>
                    
                    <div id="errorsList" style="display: none;">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Errors:</h6>
                            <ul id="errorsContent" class="mb-0"></ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-plus me-2"></i>Insert More IPs
                    </button>
                    <a href="{% url 'index' %}" class="btn btn-success">
                        <i class="fas fa-home me-2"></i>Go to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoCalculated = false;

$(document).ready(function() {
    // Auto-calculate end IP when start IP or subnet changes
    $('#startIP, #subnetBulk').on('change input', function() {
        autoCalculateEndIP();
    });
    
    // Manual change detection for end IP
    $('#endIP').on('input', function() {
        if (!autoCalculated) {
            calculateRange();
        }
        autoCalculated = false;
    });
    
    // Form submission
    $('#bulkInsertForm').on('submit', function(e) {
        e.preventDefault();
        startBulkInsert();
    });
});

function autoCalculateEndIP() {
    const startIP = $('#startIP').val().trim();
    const subnetOption = $('#subnetBulk option:selected');
    const prefix = parseInt(subnetOption.data('prefix'));
    
    if (!startIP || !prefix || prefix < 1 || prefix > 32) {
        $('#autoCalcBadge').hide();
        $('#subnetInfoCard').slideUp();
        $('#rangeInfo').html('<p class="mb-0"><i class="fas fa-info-circle me-2"></i>Enter start IP and select subnet to calculate range</p>');
        return;
    }
    
    try {
        if (!isValidIP(startIP)) {
            throw new Error('Invalid IP format');
        }
        
        const subnetMask = subnetOption.data('mask');
        const usableHosts = parseInt(subnetOption.data('usable'));
        const totalAddresses = Math.pow(2, 32 - prefix);
        
        $('#subnetDisplay').text('/' + prefix);
        $('#maskDisplay').text(subnetMask);
        $('#totalAddresses').text(totalAddresses.toLocaleString());
        $('#usableHosts').text(usableHosts.toLocaleString());
        $('#subnetInfoCard').slideDown();
        
        const startInt = ipToInt(startIP);
        const hostBits = 32 - prefix;
        
        let networkMask;
        if (prefix === 32) {
            networkMask = 0xFFFFFFFF;
        } else if (prefix === 31) {
            networkMask = 0xFFFFFFFE;
        } else {
            networkMask = (0xFFFFFFFF << hostBits) >>> 0;
        }
        
        const networkAddress = (startInt & networkMask) >>> 0;
        
        let broadcastAddress;
        let firstUsableIP;
        let lastUsableIP;
        
        if (prefix === 32) {
            broadcastAddress = networkAddress;
            firstUsableIP = networkAddress;
            lastUsableIP = networkAddress;
        } else if (prefix === 31) {
            broadcastAddress = (networkAddress | 0x00000001) >>> 0;
            firstUsableIP = networkAddress;
            lastUsableIP = broadcastAddress;
        } else {
            const wildcardMask = (~networkMask) >>> 0;
            broadcastAddress = (networkAddress | wildcardMask) >>> 0;
            firstUsableIP = (networkAddress + 1) >>> 0;
            lastUsableIP = (broadcastAddress - 1) >>> 0;
        }
        
        const startIPCalculated = intToIp(firstUsableIP);
        const endIP = intToIp(lastUsableIP);
        $('#endIP').val(endIP);
        
        const networkIP = intToIp(networkAddress);
        const broadcastIP = intToIp(broadcastAddress);
        
        if (startIP !== startIPCalculated) {
            $('#startIP').val(startIPCalculated);
            
            let notificationMsg = `Network adjusted:<br>`;
            notificationMsg += `<small><strong>Network:</strong> ${networkIP} (excluded)<br>`;
            notificationMsg += `<strong>First usable:</strong> ${startIPCalculated}<br>`;
            notificationMsg += `<strong>Last usable:</strong> ${endIP}<br>`;
            
            if (prefix > 1) {
                notificationMsg += `<strong>Broadcast:</strong> ${broadcastIP} (excluded)</small>`;
            } else {
                notificationMsg += `</small>`;
            }
            
            showNotification('info', notificationMsg);
        }
        
        autoCalculated = true;
        $('#autoCalcBadge').fadeIn();
        
        calculateRange();
        
    } catch (e) {
        console.error('Error calculating end IP:', e);
        $('#autoCalcBadge').hide();
        $('#rangeInfo').html('<p class="mb-0 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Invalid IP address format</p>');
    }
}

function isValidIP(ip) {
    const parts = ip.split('.');
    if (parts.length !== 4) return false;
    
    for (let part of parts) {
        const num = parseInt(part);
        if (isNaN(num) || num < 0 || num > 255) return false;
    }
    return true;
}

function showNotification(type, message) {
    const iconMap = {
        'info': 'info-circle',
        'success': 'check-circle',
        'warning': 'exclamation-triangle',
        'danger': 'exclamation-circle'
    };
    
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 80px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px;" 
             role="alert">
            <i class="fas fa-${iconMap[type]} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(function() {
        $('.alert.position-fixed').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 5000);
}

function calculateRange() {
    const startIP = $('#startIP').val();
    const endIP = $('#endIP').val();
    
    if (!startIP || !endIP) {
        $('#rangeInfo').html('<p class="mb-0"><i class="fas fa-info-circle me-2"></i>Enter start IP and select subnet to calculate range</p>');
        return;
    }
    
    try {
        const start = ipToInt(startIP);
        const end = ipToInt(endIP);
        
        if (start > end) {
            $('#rangeInfo').html('<p class="mb-0 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Start IP must be less than End IP</p>');
            return;
        }
        
        const total = end - start + 1;
        const formatted = total.toLocaleString();
        
        let networkSize = '';
        let subnetPrefix = '';
        
        if (total === 1) {
            networkSize = ' (Single Host - /32)';
            subnetPrefix = '/32';
        } else if (total === 2) {
            networkSize = ' (Point-to-Point - /31)';
            subnetPrefix = '/31';
        } else if (total === 254) {
            networkSize = ' (/24 Class C - 254 usable)';
            subnetPrefix = '/24';
        } else if (total === 65534) {
            networkSize = ' (/16 Class B - 65,534 usable)';
            subnetPrefix = '/16';
        } else if (total === 16777214) {
            networkSize = ' (/8 Class A - 16,777,214 usable)';
            subnetPrefix = '/8';
        } else {
            networkSize = ' (Custom range)';
            subnetPrefix = '';
        }
        
        let alertClass = 'alert-info';
        let icon = 'fa-info-circle';
        
        if (total > 5000000) {
            alertClass = 'alert-danger';
            icon = 'fa-exclamation-triangle';
        } else if (total > 1000000) {
            alertClass = 'alert-warning';
            icon = 'fa-exclamation-circle';
        } else if (total > 10000) {
            alertClass = 'alert-info';
            icon = 'fa-info-circle';
        } else {
            alertClass = 'alert-success';
            icon = 'fa-check-circle';
        }
        
        $('#rangeInfo').removeClass().addClass(`alert ${alertClass} mb-0`);
        
        let rangeHtml = `
            <p class="mb-2">
                <i class="fas ${icon} me-2"></i>
                <strong>Total IPs: ${formatted}${networkSize}</strong>
            </p>
        `;
        
        if (subnetPrefix) {
            const selectedPrefix = $('#subnetBulk option:selected').data('prefix');
            if (selectedPrefix) {
                rangeHtml += `<p class="mb-2"><small class="text-muted"><strong>Network:</strong> ${subnetPrefix} • <strong>Usable hosts:</strong> ${formatted}</small></p>`;
            }
        }
        
        rangeHtml += `
            <small><strong>From:</strong> ${startIP}</small><br>
            <small><strong>To:</strong> ${endIP}</small>
        `;
        
        $('#rangeInfo').html(rangeHtml);
        
        if (total > 5000000) {
            $('#rangeInfo').append('<hr class="my-2"><small class="text-danger"><strong>⚠️ Range exceeds maximum limit of 5,000,000 IPs</strong><br>Please select a smaller range.</small>');
        } else if (total > 1000000) {
            $('#rangeInfo').append('<hr class="my-2"><small class="text-warning">⏱️ Large range - may take 15-30 minutes to process</small>');
        } else if (total > 100000) {
            $('#rangeInfo').append('<hr class="my-2"><small class="text-info">⏱️ Medium range - may take 2-5 minutes</small>');
        } else if (total > 10000) {
            $('#rangeInfo').append('<hr class="my-2"><small>⏱️ Expected processing time: 30-120 seconds</small>');
        } else if (total > 1000) {
            $('#rangeInfo').append('<hr class="my-2"><small>⏱️ Expected processing time: 10-30 seconds</small>');
        } else {
            $('#rangeInfo').append('<hr class="my-2"><small class="text-success">✓ Quick processing expected (under 10 seconds)</small>');
        }
        
    } catch (e) {
        $('#rangeInfo').html('<p class="mb-0 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Invalid IP address format</p>');
    }
}

function ipToInt(ip) {
    const parts = ip.split('.');
    if (parts.length !== 4) throw new Error('Invalid IP');
    return ((parseInt(parts[0]) << 24) + (parseInt(parts[1]) << 16) + 
           (parseInt(parts[2]) << 8) + parseInt(parts[3])) >>> 0;
}

function intToIp(int) {
    return [
        (int >>> 24) & 255,
        (int >>> 16) & 255,
        (int >>> 8) & 255,
        int & 255
    ].join('.');
}

function startBulkInsert() {
    const formData = {
        start_ip: $('#startIP').val(),
        end_ip: $('#endIP').val(),
        branch_id: $('#branchBulk').val(),
        subnet_id: $('#subnetBulk').val(),
        device_type_id: $('#deviceTypeBulk').val(),
        device_name_prefix: $('#devicePrefix').val(),
        description: $('#descriptionBulk').val(),
        skip_existing: $('#skipExisting').is(':checked')
    };
    
    if (!formData.start_ip || !formData.end_ip || !formData.branch_id || 
        !formData.subnet_id || !formData.device_type_id) {
        showAlert('warning', 'Please fill in all required fields');
        return;
    }
    
    // Disable form
    $('#bulkInsertBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...');
    $('#bulkInsertForm input, #bulkInsertForm select, #bulkInsertForm textarea').prop('disabled', true);
    
    // Show progress
    $('#progressCard').slideDown();
    $('#progressBar').css('width', '10%').text('10%');
    $('#progressText').html('<small class="text-muted">Starting bulk insert...</small>');
    
    // Send request
    $.ajax({
        url: '/bulk-insert/',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            $('#progressBar').css('width', '100%').text('100%').removeClass('progress-bar-animated');
            $('#progressText').html('<small class="text-success"><i class="fas fa-check me-2"></i>Complete!</small>');
            
            setTimeout(function() {
                showResults(response);
            }, 500);
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            $('#progressBar').removeClass('progress-bar-animated').addClass('bg-danger');
            $('#progressText').html('<small class="text-danger"><i class="fas fa-times me-2"></i>Error occurred</small>');
            
            showAlert('danger', response.error || 'Unknown error occurred');
            
            // Re-enable form
            $('#bulkInsertBtn').prop('disabled', false).html('<i class="fas fa-upload me-2"></i>Start Bulk Insert');
            $('#bulkInsertForm input, #bulkInsertForm select, #bulkInsertForm textarea').prop('disabled', false);
        }
    });
}

function showResults(response) {
    $('#insertedCount').text(response.inserted.toLocaleString());
    $('#skippedCount').text(response.skipped.toLocaleString());
    $('#totalCount').text(response.total_processed.toLocaleString());
    
    let detailsHtml = `
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Details:</h6>
            <p class="mb-1"><strong>IP Range:</strong> ${response.start_ip} - ${response.end_ip}</p>
            <p class="mb-0">${response.message}</p>
        </div>
    `;
    
    $('#resultDetails').html(detailsHtml);
    
    if (response.errors && response.errors.length > 0) {
        let errorsHtml = '';
        response.errors.forEach(function(error) {
            errorsHtml += `<li>${error}</li>`;
        });
        $('#errorsContent').html(errorsHtml);
        $('#errorsList').show();
    }
    
    $('#resultsModal').modal('show');
}
</script>
{% endblock %}